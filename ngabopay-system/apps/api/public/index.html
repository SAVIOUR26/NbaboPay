<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>NgaboPay - Crypto to Mobile Money</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            'ngabo': {
              'dark': '#1a1f2e',
              'darker': '#141821',
              'card': '#242937',
              'border': '#2d3344',
              'accent': '#10b981'
            }
          }
        }
      }
    }
  </script>
  <style>
    body { background-color: #141821; }
  </style>
</head>
<body class="min-h-screen text-white">

  <!-- Login Page -->
  <div id="login-page" class="min-h-screen flex items-center justify-center p-4">
    <div class="w-full max-w-md">
      <div class="text-center mb-8">
        <div class="inline-flex items-center justify-center w-16 h-16 bg-gradient-to-br from-emerald-500 to-emerald-600 rounded-2xl mb-4 shadow-lg">
          <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
        </div>
        <h1 class="text-3xl font-bold mb-2">NgaboPay</h1>
        <p class="text-gray-400">Crypto to Mobile Money</p>
      </div>

      <div class="bg-ngabo-card border border-ngabo-border rounded-2xl p-8">
        <h2 class="text-lg font-semibold mb-6 text-center">Sign In</h2>

        <div id="login-error" class="hidden mb-4 p-3 bg-red-500/10 border border-red-500/20 rounded-lg text-red-400 text-sm"></div>

        <form id="login-form" class="space-y-4">
          <div>
            <label class="block text-sm font-medium text-gray-300 mb-2">Email</label>
            <input type="email" id="email" class="w-full px-4 py-3 bg-ngabo-dark border border-ngabo-border rounded-lg text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-emerald-500" placeholder="admin@ngabopay.online" required>
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-300 mb-2">Password</label>
            <input type="password" id="password" class="w-full px-4 py-3 bg-ngabo-dark border border-ngabo-border rounded-lg text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-emerald-500" placeholder="Enter your password" required>
          </div>

          <button type="submit" id="login-btn" class="w-full py-3 px-4 bg-gradient-to-r from-emerald-500 to-emerald-600 text-white font-semibold rounded-lg hover:from-emerald-600 hover:to-emerald-700 transition-all duration-300 disabled:opacity-50">
            Sign In
          </button>
        </form>
      </div>
    </div>
  </div>

  <!-- Dashboard Page -->
  <div id="dashboard-page" class="hidden min-h-screen">
    <!-- Header -->
    <header class="bg-ngabo-card border-b border-ngabo-border px-6 py-4">
      <div class="max-w-7xl mx-auto flex justify-between items-center">
        <div class="flex items-center space-x-3">
          <div class="w-10 h-10 bg-gradient-to-br from-emerald-500 to-emerald-600 rounded-xl flex items-center justify-center">
            <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
          </div>
          <span class="text-xl font-bold">NgaboPay</span>
        </div>
        <div class="flex items-center space-x-4">
          <span id="merchant-name" class="text-gray-400"></span>
          <button onclick="logout()" class="px-4 py-2 text-gray-400 hover:text-white transition">Logout</button>
        </div>
      </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto p-6">
      <!-- Status Cards -->
      <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
        <div class="bg-ngabo-card border border-ngabo-border rounded-xl p-5">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-gray-400 text-sm">Binance Status</p>
              <p id="binance-status" class="text-2xl font-bold text-yellow-500">Not Connected</p>
            </div>
            <div class="w-12 h-12 bg-yellow-500/10 rounded-full flex items-center justify-center">
              <svg class="w-6 h-6 text-yellow-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
              </svg>
            </div>
          </div>
        </div>

        <div class="bg-ngabo-card border border-ngabo-border rounded-xl p-5">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-gray-400 text-sm">USSD Device</p>
              <p id="device-status" class="text-2xl font-bold text-gray-500">Offline</p>
            </div>
            <div class="w-12 h-12 bg-gray-500/10 rounded-full flex items-center justify-center">
              <svg class="w-6 h-6 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 18h.01M8 21h8a2 2 0 002-2V5a2 2 0 00-2-2H8a2 2 0 00-2 2v14a2 2 0 002 2z" />
              </svg>
            </div>
          </div>
        </div>

        <div class="bg-ngabo-card border border-ngabo-border rounded-xl p-5">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-gray-400 text-sm">Today's Orders</p>
              <p id="orders-count" class="text-2xl font-bold">0</p>
            </div>
            <div class="w-12 h-12 bg-emerald-500/10 rounded-full flex items-center justify-center">
              <svg class="w-6 h-6 text-emerald-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
              </svg>
            </div>
          </div>
        </div>

        <div class="bg-ngabo-card border border-ngabo-border rounded-xl p-5">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-gray-400 text-sm">Total Volume</p>
              <p id="total-volume" class="text-2xl font-bold">0 USDT</p>
            </div>
            <div class="w-12 h-12 bg-blue-500/10 rounded-full flex items-center justify-center">
              <svg class="w-6 h-6 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
            </div>
          </div>
        </div>
      </div>

      <!-- Tabs -->
      <div class="bg-ngabo-card border border-ngabo-border rounded-xl overflow-hidden">
        <div class="border-b border-ngabo-border">
          <nav class="flex">
            <button onclick="showTab('binance')" id="tab-binance" class="px-6 py-4 text-emerald-500 border-b-2 border-emerald-500 font-medium">Binance Monitor</button>
            <button onclick="showTab('transactions')" id="tab-transactions" class="px-6 py-4 text-gray-400 hover:text-white font-medium">Transactions</button>
            <button onclick="showTab('settings')" id="tab-settings" class="px-6 py-4 text-gray-400 hover:text-white font-medium">Settings</button>
          </nav>
        </div>

        <!-- Binance Tab -->
        <div id="content-binance" class="p-6">
          <div class="max-w-2xl">
            <h3 class="text-xl font-bold mb-4">Binance P2P Monitoring</h3>
            <p class="text-gray-400 mb-6">Monitor your Binance P2P orders. When a buyer marks payment as complete, the system will automatically trigger USSD payout.</p>

            <div class="space-y-4">
              <button onclick="launchBinance()" class="w-full py-3 px-4 bg-yellow-500 text-black font-semibold rounded-lg hover:bg-yellow-400 transition">
                Launch Binance Browser
              </button>
              <button onclick="checkLogin()" class="w-full py-3 px-4 bg-ngabo-dark border border-ngabo-border text-white font-semibold rounded-lg hover:bg-ngabo-card transition">
                Verify Login Status
              </button>
              <button onclick="startMonitoring()" class="w-full py-3 px-4 bg-emerald-500 text-white font-semibold rounded-lg hover:bg-emerald-600 transition">
                Start Monitoring
              </button>
            </div>

            <div id="binance-message" class="mt-4 p-4 rounded-lg hidden"></div>
          </div>
        </div>

        <!-- Transactions Tab -->
        <div id="content-transactions" class="p-6 hidden">
          <h3 class="text-xl font-bold mb-4">Recent Transactions</h3>
          <div class="overflow-x-auto">
            <table class="w-full">
              <thead>
                <tr class="text-left text-gray-400 text-sm">
                  <th class="pb-4">Time</th>
                  <th class="pb-4">Amount</th>
                  <th class="pb-4">Phone</th>
                  <th class="pb-4">Status</th>
                </tr>
              </thead>
              <tbody id="transactions-table">
                <tr>
                  <td colspan="4" class="text-center text-gray-500 py-8">No transactions yet</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- Settings Tab -->
        <div id="content-settings" class="p-6 hidden">
          <div class="max-w-2xl space-y-8">
            <!-- Telegram Settings -->
            <div>
              <h3 class="text-xl font-bold mb-4">Telegram Notifications</h3>
              <div class="space-y-4">
                <div>
                  <label class="block text-sm font-medium text-gray-300 mb-2">Bot Token</label>
                  <input type="text" id="telegram-token" class="w-full px-4 py-3 bg-ngabo-dark border border-ngabo-border rounded-lg text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-emerald-500" placeholder="123456789:ABCdefGHIjklMNOpqrsTUVwxyz">
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-300 mb-2">Chat ID</label>
                  <input type="text" id="telegram-chat-id" class="w-full px-4 py-3 bg-ngabo-dark border border-ngabo-border rounded-lg text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-emerald-500" placeholder="-1001234567890">
                </div>
                <div class="flex space-x-4">
                  <button onclick="saveTelegram()" class="px-6 py-2 bg-emerald-500 text-white rounded-lg hover:bg-emerald-600 transition">Save</button>
                  <button onclick="testTelegram()" class="px-6 py-2 bg-ngabo-dark border border-ngabo-border text-white rounded-lg hover:bg-ngabo-card transition">Test</button>
                </div>
              </div>
            </div>

            <!-- USSD Settings -->
            <div>
              <h3 class="text-xl font-bold mb-4">Mobile Money / USSD</h3>
              <div class="space-y-4">
                <div>
                  <label class="block text-sm font-medium text-gray-300 mb-2">Provider</label>
                  <select id="ussd-provider" class="w-full px-4 py-3 bg-ngabo-dark border border-ngabo-border rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-emerald-500">
                    <option value="mtn">MTN Mobile Money</option>
                    <option value="airtel">Airtel Money</option>
                  </select>
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-300 mb-2">USSD Format</label>
                  <input type="text" id="ussd-format" class="w-full px-4 py-3 bg-ngabo-dark border border-ngabo-border rounded-lg text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-emerald-500" placeholder="*165*1*{phone}*{amount}*{pin}#">
                  <p class="text-gray-500 text-sm mt-1">Variables: {phone}, {amount}, {pin}</p>
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-300 mb-2">Agent PIN</label>
                  <input type="password" id="ussd-pin" class="w-full px-4 py-3 bg-ngabo-dark border border-ngabo-border rounded-lg text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-emerald-500" placeholder="****">
                </div>
                <button onclick="saveUSSD()" class="px-6 py-2 bg-emerald-500 text-white rounded-lg hover:bg-emerald-600 transition">Save USSD Settings</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <script>
    const API_BASE = '/api';
    let token = localStorage.getItem('ngabopay_token');

    // Check if already logged in
    if (token) {
      showDashboard();
    }

    // Login form handler
    document.getElementById('login-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;
      const errorDiv = document.getElementById('login-error');
      const btn = document.getElementById('login-btn');

      btn.disabled = true;
      btn.textContent = 'Signing in...';
      errorDiv.classList.add('hidden');

      try {
        const res = await fetch(`${API_BASE}/auth/login`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, password })
        });

        const data = await res.json();

        if (!res.ok) {
          throw new Error(data.error || 'Login failed');
        }

        localStorage.setItem('ngabopay_token', data.token);
        localStorage.setItem('ngabopay_merchant', JSON.stringify(data.merchant));
        token = data.token;
        showDashboard();
      } catch (err) {
        errorDiv.textContent = err.message;
        errorDiv.classList.remove('hidden');
      } finally {
        btn.disabled = false;
        btn.textContent = 'Sign In';
      }
    });

    function showDashboard() {
      document.getElementById('login-page').classList.add('hidden');
      document.getElementById('dashboard-page').classList.remove('hidden');

      const merchant = JSON.parse(localStorage.getItem('ngabopay_merchant') || '{}');
      document.getElementById('merchant-name').textContent = merchant.businessName || merchant.email || '';

      loadDashboardData();
    }

    function logout() {
      localStorage.removeItem('ngabopay_token');
      localStorage.removeItem('ngabopay_merchant');
      token = null;
      document.getElementById('login-page').classList.remove('hidden');
      document.getElementById('dashboard-page').classList.add('hidden');
    }

    function showTab(tabName) {
      // Hide all content
      document.querySelectorAll('[id^="content-"]').forEach(el => el.classList.add('hidden'));
      // Reset all tabs
      document.querySelectorAll('[id^="tab-"]').forEach(el => {
        el.classList.remove('text-emerald-500', 'border-b-2', 'border-emerald-500');
        el.classList.add('text-gray-400');
      });
      // Show selected content
      document.getElementById(`content-${tabName}`).classList.remove('hidden');
      // Highlight selected tab
      const tab = document.getElementById(`tab-${tabName}`);
      tab.classList.remove('text-gray-400');
      tab.classList.add('text-emerald-500', 'border-b-2', 'border-emerald-500');
    }

    async function apiCall(endpoint, method = 'GET', body = null) {
      const options = {
        method,
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        }
      };
      if (body) options.body = JSON.stringify(body);

      const res = await fetch(`${API_BASE}${endpoint}`, options);
      return res.json();
    }

    async function loadDashboardData() {
      try {
        // Load Binance status
        const binanceStatus = await apiCall('/binance/session-status');
        document.getElementById('binance-status').textContent = binanceStatus.isValid ? 'Connected' : 'Not Connected';
        document.getElementById('binance-status').className = `text-2xl font-bold ${binanceStatus.isValid ? 'text-emerald-500' : 'text-yellow-500'}`;

        // Load orders
        const orders = await apiCall('/orders?limit=10');
        if (orders.orders) {
          document.getElementById('orders-count').textContent = orders.orders.length;
          renderTransactions(orders.orders);
        }
      } catch (err) {
        console.error('Failed to load dashboard data:', err);
      }
    }

    function renderTransactions(orders) {
      const tbody = document.getElementById('transactions-table');
      if (!orders || orders.length === 0) {
        tbody.innerHTML = '<tr><td colspan="4" class="text-center text-gray-500 py-8">No transactions yet</td></tr>';
        return;
      }

      tbody.innerHTML = orders.map(order => `
        <tr class="border-t border-ngabo-border">
          <td class="py-4">${new Date(order.createdAt).toLocaleString()}</td>
          <td class="py-4">${order.cryptoAmount} ${order.cryptoCurrency}</td>
          <td class="py-4">${order.customerPhone || '-'}</td>
          <td class="py-4">
            <span class="px-2 py-1 rounded text-xs ${
              order.status === 'completed' ? 'bg-emerald-500/20 text-emerald-400' :
              order.status === 'failed' ? 'bg-red-500/20 text-red-400' :
              'bg-yellow-500/20 text-yellow-400'
            }">${order.status}</span>
          </td>
        </tr>
      `).join('');
    }

    async function launchBinance() {
      showBinanceMessage('Launching browser...', 'info');
      try {
        const result = await apiCall('/binance/launch-browser', 'POST');
        showBinanceMessage(result.message || 'Browser launched! Login to your Binance account.', 'success');
      } catch (err) {
        showBinanceMessage(err.message || 'Failed to launch browser', 'error');
      }
    }

    async function checkLogin() {
      showBinanceMessage('Checking login status...', 'info');
      try {
        const result = await apiCall('/binance/check-login', 'POST');
        showBinanceMessage(result.message || (result.loggedIn ? 'Logged in!' : 'Not logged in yet'), result.loggedIn ? 'success' : 'warning');
        loadDashboardData();
      } catch (err) {
        showBinanceMessage(err.message || 'Failed to check login', 'error');
      }
    }

    async function startMonitoring() {
      showBinanceMessage('Starting monitoring...', 'info');
      try {
        const result = await apiCall('/binance/start-monitoring', 'POST');
        showBinanceMessage(result.message || 'Monitoring started!', 'success');
        loadDashboardData();
      } catch (err) {
        showBinanceMessage(err.message || 'Failed to start monitoring', 'error');
      }
    }

    function showBinanceMessage(text, type) {
      const div = document.getElementById('binance-message');
      div.textContent = text;
      div.className = `mt-4 p-4 rounded-lg ${
        type === 'success' ? 'bg-emerald-500/20 text-emerald-400' :
        type === 'error' ? 'bg-red-500/20 text-red-400' :
        type === 'warning' ? 'bg-yellow-500/20 text-yellow-400' :
        'bg-blue-500/20 text-blue-400'
      }`;
      div.classList.remove('hidden');
    }

    async function saveTelegram() {
      const botToken = document.getElementById('telegram-token').value;
      const chatId = document.getElementById('telegram-chat-id').value;

      try {
        await apiCall('/config/TELEGRAM_BOT_TOKEN', 'PUT', { value: botToken });
        await apiCall('/config/TELEGRAM_CHAT_ID', 'PUT', { value: chatId });
        alert('Telegram settings saved!');
      } catch (err) {
        alert('Failed to save: ' + err.message);
      }
    }

    async function testTelegram() {
      try {
        const result = await apiCall('/config/telegram/test', 'POST');
        alert(result.success ? 'Test message sent!' : 'Failed: ' + result.error);
      } catch (err) {
        alert('Failed: ' + err.message);
      }
    }

    async function saveUSSD() {
      const provider = document.getElementById('ussd-provider').value;
      const format = document.getElementById('ussd-format').value;
      const pin = document.getElementById('ussd-pin').value;

      try {
        await apiCall('/config/batch', 'POST', {
          configs: [
            { key: 'USSD_PROVIDER', value: provider },
            { key: 'USSD_FORMAT', value: format },
            { key: 'MOBILE_MONEY_PIN', value: pin }
          ]
        });
        alert('USSD settings saved!');
      } catch (err) {
        alert('Failed to save: ' + err.message);
      }
    }

    // Auto-refresh dashboard data every 30 seconds
    setInterval(() => {
      if (token) loadDashboardData();
    }, 30000);
  </script>
</body>
</html>
